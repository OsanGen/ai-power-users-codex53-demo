Systems Component

Purpose:
- Own input handling, simulation loop, state transitions, and combat lifecycle.
- Enforce floor/chapter flow between title, upgrade, briefings, lesson slides, play, clear, death, and end states.
- Coordinate world entity lifecycle for player, bullets, enemies, pickups, particles, and death state.
- Minimize runtime allocation in hot simulation paths via pooled entity objects and collision-epoch gating.

Inputs:
- `AIPU.dom` for canvas and overlay button references.
- `AIPU.state` shared mutable state for game and player.
- `AIPU.constants` for gameplay and pacing constants.
- `AIPU.content` for floor data, narrative content, enemy definitions, and UI copy.
- `AIPU.upgrades` for derived stats, upgrades, and max HP tuning.
- `AIPU.share` for share modal entry.
- `AIPU.utils` for math/utility helpers.
- `AIPU.utils` random helpers as high-frequency spawner and burst emitters.

Outputs:
- Mutates `AIPU.state` across all game states:
  - `TITLE`, `UPGRADE_SELECT`, `BOMB_BRIEFING`, `LESSON_SLIDE`, `FLOOR_INTRO`, `PLAYING`, `DEATH_ANIM`, `DEATH_LESSON`, `FLOOR_CLEAR`, `GAME_OVER`, `VICTORY`.
- Exposes `AIPU.systems` APIs:
  - `currentFloor`
  - `update`, `updateGameplay`
  - movement/shooting/update helpers
  - `triggerBomb`, `getDeathShakeOffset`, `startDeathAnim`
  - `enterGameOver`, `requestRestart`, `startRun`, `startFloor`, `beginCurrentFloor`
  - `resolveDirectionalBurstMode`, `getDirectionalBurstStatus`
  - `getCollections`
- `applyPlayerDamage` returns a boolean hit-result and writes debug diagnostics when `game.showDebugStats` is enabled.
- Internal pools are not exported but remain stable during state transitions.

State/Edges:
- Input model:
  - Tracks movement and action keys in `AIPU.input.keys`.
  - Normalizes movement key handling by `event.code` and supports single-press guards.
- State gates:
  - BOMB_BRIEFING, LESSON_SLIDE, DEATH_LESSON, UPGRADE_SELECT, FLOOR_INTRO, and FLOOR_CLEAR are non-combat overlay/input-break states for shooting.
  - `updatePlayerShooting` exits early unless `game.state === PLAYING`.
  - `updatePlayerMovement` and camera-independent gameplay updates continue as designed in noncombat states already using explicit state checks.
- Burst system:
  - Tracks hold time only while directional shoot key is held in PLAYING.
  - Enforces floor unlock rules for dual/omni modes.
- Damage pipeline:
  - `handleCollisions()` now routes collisions through `applyPlayerDamage` and records skipped/blocked hit events when debug mode is enabled.
  - `applyPlayerDamage()` validates damage source values and player health/shield state before mutating HP.
  - `applyPlayerDamage()` now clamps malformed source coordinates to player position so knockback math never receives `NaN`.
  - Upgrade selection debug output is now guarded through the shared debug flag and includes a floor id fallback when floor context is missing.
  - Damage is treated as skipped only for explicit guard conditions and is traceable by reason in debug logs.
- Entity performance:
  - Uses reusable pools for bullets, enemy bullets, enemies, pickups, and particles.
  - Releases pooled objects on all collection exits (death, collisions, pickups, timeouts, and bomb clear).
  - Collision gating uses bullet hit epoch tokens instead of per-bullet `Set` allocations.
- Death and lesson flow:
  - Death animation transitions to DEATH_LESSON and then GAME_OVER on confirmation.
  - Lesson slides interposed between upgrade acceptance and floor start.

Dependencies:
- `AIPU.upgrades` for stat aggregation and upgrade selection.
- `AIPU.share.shareUI` for modal lifecycle.
- `AIPU.renderCache` for cache invalidation in floor/state resets.

Acceptance Checks:
- No combat actions occur during lesson/briefing intro/clear overlays.
- Resume from overlays returns to intended states without stale key-repeat artifacts.
- Upgrades, checkpoint handling, and bomb briefing transitions remain deterministic per state.
- Death flow continues to DEATH_LESSON first and then GAME_OVER on explicit confirm input.
- All pooled objects are fully reset before reuse; render-facing fields remain unchanged (`x`, `y`, `vx`, `vy`, `radius`, `hp`, `hp` etc.) and no gameplay tuning or UI copy changes.
- Headless floor-start smoke check: forcing startRun(10) reaches UPGRADE_SELECT → LESSON_SLIDE → FLOOR_INTRO → PLAYING with no runtime transition errors.
