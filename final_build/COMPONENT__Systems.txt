Systems Component

Purpose:
- Own input handling, simulation loop, state transitions, and combat lifecycle.
- Enforce floor/chapter flow between title, upgrade, briefings, lesson slides, play, clear, death, and end states.
- Coordinate world entity lifecycle for player, bullets, enemies, pickups, particles, and death state.
- Minimize runtime allocation in hot simulation paths via pooled entity objects and collision-epoch gating.

Inputs:
- `AIPU.dom` for canvas and overlay button references.
- `AIPU.state` shared mutable state for game and player.
- `AIPU.constants` for gameplay and pacing constants.
- `AIPU.content` for floor data, narrative content, enemy definitions, and UI copy.
- `AIPU.upgrades` for derived stats, upgrades, and max HP tuning.
- `AIPU.share` for share modal entry.
- `AIPU.utils` for math/utility helpers.
- `AIPU.utils` random helpers as high-frequency spawner and burst emitters.

Outputs:
- Mutates `AIPU.state` across all game states:
  - `TITLE`, `UPGRADE_SELECT`, `BOMB_BRIEFING`, `LESSON_SLIDE`, `FLOOR_INTRO`, `PLAYING`, `DEATH_ANIM`, `DEATH_LESSON`, `FLOOR_CLEAR`, `GAME_OVER`, `VICTORY`.
- Exposes `AIPU.systems` APIs:
  - `currentFloor`
  - `update`, `updateGameplay`
  - movement/shooting/update helpers
  - `triggerBomb`, `getDeathShakeOffset`, `startDeathAnim`
  - `enterGameOver`, `requestRestart`, `startRun`, `startFloor`, `beginCurrentFloor`
  - `resolveDirectionalBurstMode`, `getDirectionalBurstStatus`
  - `getCollections`
- `applyPlayerDamage` returns a boolean hit-result and writes debug diagnostics when `game.showDebugStats` is enabled.
- Internal pools are not exported but remain stable during state transitions.

State/Edges:
- Input model:
  - Tracks movement and action keys in `AIPU.input.keys`.
  - Normalizes key handling from `event.code` with fallback aliases for legacy `event.key` values (`Up`/`Down`/`Left`/`Right`) and single-char movement fallback.
  - Movement is `WASD` (`KeyW/KeyA/KeyS/KeyD`), while shoot direction is read from arrow keys (`ArrowUp/ArrowDown/ArrowLeft/ArrowRight`).
  - Numpad directional controls (`Numpad8/2/4/6`) are normalized to arrow directions for shooting where the browser reports keypad codes.
  - Stops writing raw/non-canonical key strings into `AIPU.input.keys` during input capture, which prevents unexpected overlap between gameplay systems.
  - Removes legacy alias writes (e.g., trailing-letter keys) so arrow input cannot mutate unrelated key slots.
  - `lastShootKey` is reset on global input clear and refreshed on any canonical shoot-key release (`event.code` or `event.key` fallback) to avoid stale direction carrying over when keys are released.
- State gates:
  - BOMB_BRIEFING, LESSON_SLIDE, DEATH_LESSON, UPGRADE_SELECT, FLOOR_INTRO, and FLOOR_CLEAR are non-combat overlay/input-break states for shooting.
  - `updatePlayerShooting` exits early unless `game.state === PLAYING`.
  - `updatePlayerMovement` and camera-independent gameplay updates continue as designed in noncombat states already using explicit state checks.
  - Space-bomb activation is gated by a resolved floor-id path (`current floor` → `game.currentFloorIndex` fallback), and no bomb activation can occur before unlock floor or when floor charge allocation is 0.
  - Background audio is started when a floor begins (`beginCurrentFloor`) and stopped in terminal/transition states (`toTitle`, `enterGameOver`, `VICTORY`) through explicit `AIPU.audio` calls.
- Reset invariants:
  - `toTitle()` clears canonical input state (`keys`, `lastShootKey`, `shootPressOrder`) before state reset to prevent latched movement/shoot keys across run boundaries.
  - `resetCollections()` clears `activeWaves` in addition to pooled entity arrays to prevent stale spawn schedules after title/restart transitions.
  - `player.attackDisableTimer` is reset in title transitions and floor/game state starts so lockout does not persist across run reset paths.
- Burst system:
  - Tracks hold time only while directional shoot key is held in PLAYING.
  - Enforces floor unlock rules for dual/omni modes.
- Damage pipeline:
  - `handleCollisions()` now routes collisions through `applyPlayerDamage` and records skipped/blocked hit events when debug mode is enabled.
  - Homing missiles (`behavior: "homing_missile"`, including `type: "dual"`) no longer apply touch damage directly on contact; they instead explode visually, are removed, and trigger a fixed-duration player fire lockout.
  - `applyPlayerDamage()` validates damage source values and player health/shield state before mutating HP.
  - `applyPlayerDamage()` now clamps malformed source coordinates to player position so knockback math never receives `NaN`.
  - Upgrade selection debug output is now guarded through the shared debug flag and includes a floor id fallback when floor context is missing.
  - Damage is treated as skipped only for explicit guard conditions and is traceable by reason in debug logs.
- Simulation hardening:
  - `update(deltaTime)` clamps oversized frame input into a bounded accumulator, ignores non-finite or non-positive deltas, and resets accumulator if internal timing state becomes invalid.
  - `resolveDirectionalBurstMode(...)` safely parses numeric floor input before threshold checks.
  - `heartDropChance(...)` defaults malformed floor heart-config fields and preserves stable clamp behavior.
- Spawn control:
  - `updateSpawns()` sanitizes malformed wave metadata and numeric fields (timing, rates, speed multipliers, speed, size, damage, hp) before computation and entity creation.
  - `spawnEnemyFromWave()` ignores malformed wave objects and creates entities only from valid enemy definitions.
  - `updateSpawns()` enforces a regular-entity soft cap (`ENEMY_SPAWN_SOFT_CAP`) while allowing `dual` missiles to continue spawning during their wave windows up to a higher cap (`DUAL_SPAWN_SOFT_CAP`) so homing-missile visibility is preserved in dense combat frames.
- Entity performance:
  - Uses reusable pools for bullets, enemy bullets, enemies, pickups, and particles.
  - Releases pooled objects on all collection exits (death, collisions, pickups, timeouts, and bomb clear).
  - Collision gating uses bullet hit epoch tokens instead of per-bullet `Set` allocations.
- Death and lesson flow:
  - Death animation transitions to DEATH_LESSON and then GAME_OVER on confirmation.
  - Lesson slides interposed between upgrade acceptance and floor start.

- Audio side effects:
  - `beginCurrentFloor()` calls `AIPU.audio.playForFloor(floor.id)` if the audio module is available.
  - Title, game over, and victory transitions stop playback explicitly to prevent stale looping.

Dependencies:
- `AIPU.upgrades` for stat aggregation and upgrade selection.
- `AIPU.share.shareUI` for modal lifecycle.
- `AIPU.renderCache` for cache invalidation in floor/state resets.

Acceptance Checks:
- No combat actions occur during lesson/briefing intro/clear overlays.
- Resume from overlays returns to intended states without stale key-repeat artifacts.
- Upgrades, checkpoint handling, and bomb briefing transitions remain deterministic per state.
- Death flow continues to DEATH_LESSON first and then GAME_OVER on explicit confirm input.
- All pooled objects are fully reset before reuse; render-facing fields remain unchanged (`x`, `y`, `vx`, `vy`, `radius`, `hp`, `hp` etc.) and no gameplay tuning or UI copy changes.
- Headless floor-start smoke check: forcing startRun(10) reaches UPGRADE_SELECT → LESSON_SLIDE → FLOOR_INTRO → PLAYING with no runtime transition errors.
- Calling `toTitle()` after injecting pressed keys leaves all input channels cleared (`keys` false, `lastShootKey` empty, `shootPressOrder` empty).
- Calling `toTitle()` from PLAYING leaves `activeWaves` count at `0` in `render_game_to_text` snapshots.
- Calling `update()` with non-finite/zero-or-negative `deltaTime` does not mutate simulation state and leaves `simAccumulator` bounded and recoverable.
- `updateSpawns()` ignores malformed wave objects; malformed numeric fields in `activeWaves` entries do not throw or stall.
- Calling `triggerBomb()` while `game.bombChargesPerFloor` is `0` never mutates enemies or charge state, and floor-locked floors below `BOMB_UNLOCK_FLOOR` reject activation even if charges are stale.
- Homing-missile collision path keeps `applyPlayerDamage` from being called on `dual` impacts, yet always emits contact feedback and forces `attackDisableTimer` to the configured lockout duration.
- Dual-wave spawn pressure remains active when standard enemy count is saturated, so entering high-traffic states no longer suppresses `dual` wave spawns.
- Floor transitions and terminal states are audio-safe:
  - Floor transitions call play/stop deterministically.
  - `enterGameOver()`, `toTitle()`, and victory path stop playback without throwing when audio is unavailable.
