Render Component

Purpose:
- Draw all visuals each frame from `AIPU.state`, including environment, entities, HUD, state overlays, and visual theme layers.
- Apply the arena floor visual themes and transition overlays while keeping gameplay state and rules unchanged.
- Add a compounded water-wrapper visual pass for floors `1..8` that deepens support-color integration and animation intensity as floors progress, with a stronger baseline on floor `1` and stronger low-floor motion amplification.
- Add optional, modularized, render-only FX feedback (camera, bullets, particles, distortion) driven by `fxState` and `FX_CONFIG`.
- Support directional player model swap and automatic enemy art routing:
  - Player sprites resolve by bucket from:
    - `assets/characters/player/main/Front.png` (front primary)
    - `assets/characters/player/main/back.png` (back primary)
    - `assets/characters/player/main/left.png` (left primary)
    - `assets/characters/player/main/right.png` (right primary)
    - movement fallback uses canonical names first, then legacy root filenames during migration.
  - Player shoot sprites resolve by bucket from:
    - `assets/characters/player/main/Down_Shoot.png` (front shoot primary)
    - `assets/characters/player/main/UP_shoot.png` (back shoot primary)
    - `assets/characters/player/main/Left_shoot.png` (left shoot primary)
    - `assets/characters/player/main/Right_shoot.png` (right shoot primary)
    - canonical shoot aliases are checked next (`shoot_front.png`, `shoot_back.png`, `shoot_left.png`, `shoot_right.png`), then legacy root fallbacks.
  - Player burst sprites resolve by `AIPU.systems.getDirectionalBurstStatus()`:
    - `dual`/`omni` states force `assets/characters/player/main/DUAL.png` (falls back to `dual.png`).
    - Otherwise movement/shoot frame logic continues as above.
    - Burst gating is render-state-stable to reduce one-frame sprite jitter.
  - Enemy sprites resolve by `enemy.type` to:
    - `assets/characters/enemies/<enemyType>/idle.png`
    - `assets/characters/enemies/<enemyType>/default.png` (optional fallback)
- Sprite URLs are cache-busted with `?v=20260221-23`.
- Shoot/move mode is resolved from active `Arrow*` keys (and `AIPU.input.lastShootKey` fallback); when no shoot key is active, movement keys are used; otherwise player facing holds its last valid direction.
  - Missing or failed sprite loads fallback to built-in directional procedural rendering.
  - Fallback draw sizing now uses the fallback frame’s own direction stance scale (not the originally requested direction), which prevents occasional stretch/pop artifacts when rendering `front` fallback frames for side/back requests.
  - Mode-switch smoothing now behaves dynamically:
    - if target mode/direction has renderable frames (or cached fallback), switch immediately with `holdFrames = 0`;
    - otherwise retain the short hold-delay path while assets resolve.
  - Player sprite mode/facing state now updates even during invulnerability blink frames, preventing stale mode carryover in debug/render state when shooting is released while blink-culled draw is active.
  - Player sprite candidates are now pre-primed once per run reset (`move`, `shoot`, `dual` across four directions) to reduce first-use frame pops when switching movement/shoot modes.

Inputs:
- Render state (`AIPU.state.game`, `AIPU.state.player`, entity collections).
- Constants and helpers from `AIPU.constants` and `AIPU.utils`.
- Narrative content helpers from `AIPU.content` for all overlay labels.
- Optional systems callbacks from `AIPU.systems` for collections and state transitions.

Outputs:
- A single frame on `canvas`.
- Overlay content for title, upgrade cards, bomb briefing, lesson/death lesson, floor intro/clear, and run summary.
- Background and world layers with per-floor visual theme data.
- Machine-readable snapshot output through `AIPU.render.renderGameToText()` (consumed by `window.render_game_to_text`).

State/Edges:
- Uses `ctx.textAlign`/`textBaseline` state carefully and resets at block exits.
- Uses `withRectClip` for lesson/death text clipping and `withClipRect` for rounded-panel masking.
- Keeps overlay text readable by top-aligned clipping paths with insets.
- Supports reduced-motion by removing motion terms.
- Adds optional background strip-warp distortion in `updateDynamicLayer()` after base corridor draw.
  - Distortion is world-only (`WORLD` clip), low tier disabled/near-flat.
  - Uses per-floor strip orientation and sinusoidal offsets from `fxState.intensity` + `visualTheme.trippyLevel`.
  - Enforces center fade and quality-based max amplitude bounds.
- Adds `getDynamicEscalation(progress)` to derive composed pressure from normalized floor progress and active threat.
  - Dynamic floor motifs (`drawFloorDynamicIdentityByPack`) receive floor progress and scale density/motion using `easeInOutSine` and `easeOutCubic`.
  - `edgeBlend(...)` applies stronger modulation toward WORLD edges so center stays clearer under escalation.
- Floors `1..8` now route through a dedicated water wrapper state (`resolveWaterWrapperState`) and two draw passes:
  - `drawWaterStaticBase(...)` for low-alpha basin bands and static caustic scaffold.
  - `drawWaterDynamicOverlay(...)` for progressive ripple/caustic motion with floor-depth compounding.
  - Added `drawWaterWashLayer(...)` as a dedicated first-pass water wash using blue/mint radial tint + moving stripe accents so 1..8 always reads strongly “watery” even at low floor depth.
  - `buildRenderGameTextState()` now emits `debug.visualState` payload (floor pack/theme/water metrics) for deterministic verification.
  - Wrapper alpha is hard-capped to maintain OSAN readability and lead-accent dominance.
- Reduced-motion support is centralized:
  - `isFxToggleEnabled` disables `trails`, `chroma`, and `grain` when `AIPU.input.prefersReducedMotion` is true.
  - `applyStripWarpDistortion()` caps distortion at ≤1px and scales distortion frequency.
  - Camera and background motion uses a dedicated reduced-motion background scale to keep shake/zoom and floor parallax in the 60–80% reduction band.
  - Lesson/title/death overlays skip or zero out motion terms when reduced-motion is enabled.
- "No hard-flash" check in visual FX paths:
  - avoid full-intensity abrupt color toggles on reduced-motion states;
  - keep chroma/reduce-motion effects below noticeable flash thresholds by clamping alpha and preserving WORLD clipping.
- Added optional high-tier chroma edge split in `applyChromaEdgeSplit()`.
  - Runs only when `FX_CONFIG.quality === "high"` and `FX_CONFIG.toggles.chroma` is true.
  - Draws a clipped 14px WORLD border band with ±1px edge offsets in one support color at low alpha.
  - Guarded to remain subtle and non-glowy (`edgeAlpha <= 0.02` effective per pass).
- Added `FLOOR_FX_PACKS` visual identity matrix (`1..15`) with lead, distortion mode, motif, parallax, lattice metadata.
- `hasDynamicFloorVisuals()` is now 1..15 and floor skins are now driven by pack selection for static + dynamic layers.
  - Floors `1..9` render enriched layered motifs; floors `10..13` add dedicated late-game overlays for stronger movement. Floors `14..15` remain no-op placeholders.
- Added dedicated late-floor static and dynamic post-nine overlay helpers so `10..13` keep visible motion pressure through edge-driven and escalated animated motifs.
- Maintains one-accent rendering by keeping support colors secondary and low-alpha only.
- No gameplay mechanics are changed in render path.
- `hasDynamicFloorVisuals` now safely accepts numeric or numeric-string floor IDs before enabling dynamic layer effects.
- Added a GLFX wrapper post-process on the world layer using `glfx.js` in `applyGlfxWorldPass()`.
  - Initializes WebGL pipeline via `initGlfxWorldFx()` / `tryCreateGlfxWorldFx()` only in render namespace.
  - Uses a cached `fxCanvas` and `sourceCanvas` to keep GLFX updates in world-space only (WORLD clip).
  - Builds tiered filter chains via `applyGlfxPassForTier()`:
    - low: subtle `bulgePinch`
    - medium: `bulgePinch + swirl`
    - high: adds muted `swirl + noise + vignette`
  - Honors reduced-motion by scaling effect down aggressively and avoiding abrupt color-heavy operations.
  - Catches runtime exceptions and falls back to existing native distortions when GLFX fails.
  - Invoked from `draw()` after world rendering and world-camera restore, before HUD and state overlay draws.
- GLFX status/error state is tracked in-process (`ready`, `applied`, `fallback`, `error`, `disabled`, `idle`), with debug surfacing in `drawDebugStatsLine`.
- Added world-layer-only character head variant in `drawPlayer()`:
  - Head now renders as a rotating cog motif with subtle per-frame color shift using floor support/accent mix.
  - Keeps lead accent dominance and avoids gameplay state changes.

Dependencies:
- `AIPU.content` narrative helper methods for labels.
- `AIPU.systems` collections and state helpers.
- `AIPU.utils` for color/geometry/font helpers.
- `index.html` script tags use cache-bust tokens (`audio.js?v=20260222-10`, `systems.js?v=20260222-10`, `render.js?v=20260222-10`, `main.js?v=20260222-10`) to force updated runtime bundle refresh.
- Sprite URLs are additionally cache-busted in `src/render.js` (`CHARACTER_ART_CACHE_BUST = "v=20260222-4"`) to avoid stale image caching across art updates.
  - Player movement resolution is labeled-first: `Front.png/back.png/left.png/right.png` with canonical and legacy root fallback.
  - Player shoot resolution is labeled-first: `Down_Shoot.png/UP_shoot.png/Left_shoot.png/Right_shoot.png` with canonical fallback aliases next.

Acceptance Checks:
- No state transitions altered by rendering.
- Lesson/death overlays remain legible with stable baseline/clipping.
- Floor themes resolve consistently by floor id.
- Prompt 12 Performance + debug
  - `drawDebugStatsLine` shows render-only FX diagnostics when `game.showDebugStats` is active.
  - Diagnostic text reports FX tier (`FX_CONFIG.quality`), particle count, and render cache hit/miss counters.
  - Removed hot-path `Set` allocations by reusing render-local sets in `updateFxState` and `pruneBulletTrails`.
- UI overlays honor current floor count:
  - `drawStateOverlay` clear-state footer only shows "Transitioning..." when floor id is below `FLOORS.length`.
- Run summary pill labels and spacing remain correctly anchored within the summary panel bounds.
- Prompt 6 impact effects implemented:
  - Render-only `fxParticles` array has object pool backed storage and cap by quality tier.
  - Hit events trigger pooled micro sparks near enemy impact points.
  - Death events trigger a ring dissolve and shard-like particles.
  - Update/draw pass runs with line/rect drawing in the world transform and does not mutate gameplay collections.
- Sprite routing behavior:
  - `drawPlayer()` first attempts bucket/legacy resolved directional player art, then falls back to procedural.
  - `buildPlayerSpriteCandidates()` now resolves labeled movement/shoot frames first, then canonical aliases, then legacy root fallback.
  - `drawEnemies()` draws resolved enemy sprites when ready for `enemy.type`, otherwise uses legacy procedural fallbacks.
  - Missing folders or malformed image files never crash render loops; missing assets produce procedural fallback.
  - Idle player facing no longer falls back to stale aim (`lastAimX/lastAimY`) when both movement and shooting inputs are inactive; facing persists for stable idle visuals and avoids intermittent direction jitter while standing still.
  - Homing missiles (`dual`) use a reinforced procedural visual fallback with darker, jittered trail geometry and pulse-coupled detail, so they remain visibly distinct and more threatening when sprites are missing.
  - Homing missile fallback was strengthened further with a staggered broken-fin silhouette, ember drift, and cracked line accents in `drawHomingMissileEnemyProcedural` to increase perceived threat without affecting movement/impact semantics.
  - `AIPU.render.getSpriteLoadState()` exposes sprite-load counters and missing-path diagnostics.
  - Sprite cache state invalidates when resolved candidate path sets change so stale path order/content can never pin a previous image after art rename or input-mode swap.
  - Malformed sprite candidates now advance through the same fallback chain as network/path load failures instead of terminating at the first invalid decode candidate.
  - Player sprite width clamp uses normalized safe radius (`playerRadius`) consistently for both min and max bounds.
- Deterministic automation compatibility:
  - `AIPU.render.renderGameToText()` emits concise JSON with coordinate-system note, mode/floor/player state, collection samples, and debug stats.
  - `AIPU.render.renderGameToText()` now also exposes `debug.audio` (when `AIPU.audio` is present) so floor music state can be validated from automation snapshots.
  - `AIPU.render.renderGameToText()` now also exposes `debug.playerSprite` mode/hold/facing internals for deterministic sprite routing and transition debugging.
  - `buildRenderGameTextState()` uses `GameState.PLAYING` in state checks to keep deterministic snapshots stable in PLAYING without reference errors.
  - `AIPU.render.renderGameToText()` now exposes `debug.visualState` with floor pack/theme and water wrapper compound/alpha metrics for floor 1–8 intensity validation.
- Sprite cache busting for character art is now `v=20260222-4`; script tags should remain aligned in `index.html` to guarantee art updates are loaded by clients.
- Script cache-bust alignment and player-cache keys are now expected at `v=20260222-6` for this stability patch.
- Player movement/shoot rendering remains driven by active `Arrow*` input during `player.attackDisableTimer > 0`, preventing stale visual mode locks after lockout.
- Run summary screen (GAME_OVER/VICTORY) is now concise and proof-first:
  - Uses compact stat chips, split-card summary blocks, and reduced line count.
  - Keeps `runSummary` actions and restart path unchanged (`Press R to restart`) and does not modify `DEATH_LESSON` composition.
  - Added second-pass polish:
    - Gradient summary lead strip for visual emphasis.
    - Shared stat-chip renderer with number-first hierarchy.
    - Threat glossary entries broken into short bullet lines for improved readability.
    - Restart action now rendered as a pill-styled CTA for clearer action affordance.
  - Added third-pass polish:
    - `runSummaryOverlay` now uses responsive panel width/spacing so narrow viewports stay inside the canvas.
    - Compact mode reduces type and spacing for smaller screens while preserving hierarchy.
    - Card and chip rendering now includes subtle shadow treatment to improve visual depth without changing data or actions.
  - Added fourth-pass polish:
    - Added a centered result badge ("VICTORY" or "RUN COMPLETE") above the summary title to instantly communicate outcome.
    - Added soft panel chrome (drop shadow, bottom rail, and accent top accent strip consistency tweaks) for elevated visual hierarchy.
    - Title/body anchors now use compact-aware vertical rhythm to reduce crowding and maintain balance across viewport sizes.
  - Added fifth-pass polish:
    - Added subtle horizontal section dividers in the summary panel to separate title/body, core stats, and action CTA.
    - Improved vertical rhythm by anchoring chips below a readable divider point and preserving compact-mode spacing.
    - Divider strokes are intentionally low-opacity ink and fog-dot accents for OSAN-style restrained visual cadence.
  - Added sixth-pass polish:
    - Added restrained chrome framing (inner contour and corner accents) around the run-summary overlay for stronger panel hierarchy.
    - Kept frame treatment subtle (low-opacity ink/fog) and consistent with existing palette constraints.
    - No text/actions were changed; only rendering hierarchy and spatial framing were adjusted.
  - Added seventh-pass polish:
    - Replaced the run-summary accent strip with restrained flat OSAN-style rails (low-coverage lead accent, fog support rail) to reduce gradient-heavy appearance.
    - Tightened heading cap rhythm and added micro heading cap lines in cards for improved proof-first reading order.
    - Refined stat chip typography and spacing to keep values legible and reduce perceived clutter while preserving all copy and behavior.
  - Added eighth-pass polish:
    - Reduced run-summary card paragraph density by rendering each row as a compact single-line clipped row (with row budget control) to avoid wall-of-text behavior.
    - Kept content/actions unchanged (`Press R to restart`, same copy keys) and preserved all summary semantics.
  - Added ninth-pass polish:
    - Added explicit overflow handling in summary cards so row-dense sections always show a capped `+N more` indicator instead of silently clipping long text.
    - Preserved exact copy keys and gameplay flow while improving density feedback in compact card blocks.
  - Added tenth-pass polish:
    - Improved summary-card overflow readability by reserving a dedicated overflow row, applying muted visual treatment to the `+N more` indicator, and keeping row budgeting stable across compact and large layouts.
    - Run-summary content/actions remain unchanged; no interaction/state semantics were touched.
  - Added eleventh-pass polish:
    - Reworked run-build row sourcing so summary cards use the full upgrade list and apply a single centralized overflow path in-card, avoiding stale/capped intermediary `+N more` counts.
    - `+N more` now always reflects true hidden-row count for compact cards, while leaving all copy keys, actions, and transitions unchanged.
  - Added twelfth-pass polish:
    - Added subtle list-scannability markers and per-row type styling in summary cards (regular row marker, muted overflow row treatment, and consistent line spacing) for denser content readability.
    - No game logic, restart flow, or overlay copy changed; only visual hierarchy in compact and normal layouts was adjusted.
  - Added thirteenth-pass polish:
    - Improved scan hierarchy by emphasizing the first visible summary card row (slightly stronger weight) while maintaining compact budgets.
    - Restored marker coverage for both numeric and plain rows, keeping bullets untouched and preserving `+N more` overflow behavior.
    - No overlay copy/actions or gameplay transitions were modified.
  - Added fourteenth-pass polish:
    - Added first-row anchor markers in summary cards with a slightly larger, stronger row marker for the top row to guide the eye in dense blocks.
    - Overflow and row-capping behavior were preserved, including existing muted `+N more` treatment.
    - No gameplay/state behavior or run-summary actions were changed.
  - Added fifteenth-pass polish:
    - Upgraded the run-summary restart CTA with a compact key-pill indicator (`R`) and subtle top-highlight rail to strengthen action affordance without changing button copy or restart semantics.
    - Kept behavior intact (`Press R to restart`) and preserved OSAN restraint by keeping the enhancement low-contrast and frame-coherent.
  - Added sixteenth-pass polish:
    - Finalized CTA readability pass by adding a low-profile footer focus rail and increasing key-pill contrast/readability with a soft inset highlight while preserving copy/interaction.
    - No text/actions/state changes; only visual affordance of the restart pill was adjusted.
  - Added seventeenth-pass polish:
    - Centered the restart CTA composite (key-chip + label) within the button for cleaner visual balance, while keeping exact `Press R to restart` behavior intact.
    - Kept spacing deterministic and compact-friendly by stabilizing chip/text geometry based on computed content width.
  - Added eighteenth-pass polish:
    - Added restrained glass-panel depth to the run-summary surface via a soft vertical gradient and accent hairline frame.
    - Upgraded the restart CTA skin with an extra subtle border depth pass and button gradient/highlight layers for OSAN-grade affordance polish.
    - Kept `Press R to restart` text, layout, and restart flow unchanged.
  - Added nineteenth-pass polish:
    - Refined the restart CTA micro-chrome by converting the key-pill to a gradient-lit token, adding an inner accent stroke, and adding a subtle divider spine before the action label.
    - Kept the same button copy, positioning, and interaction path unchanged.
  - Added twentieth-pass polish:
    - Added ambient panel veiling (subtle upper wash and vertically faded rim stroke) to increase depth on the run-summary surface without changing overlay semantics.
    - Added micro-highlight layers to the restart CTA body and key-pill shadow depth for a cleaner premium affordance under the existing copy/flow.
  - Added twenty-first-pass polish:
    - Added a cleaner panel sheen wash and CTA micro-focus detail (subtle sheen stripe + terminal accent mark) for improved legibility contrast.
    - Kept `Press R to restart` copy/action and all gameplay transitions unchanged.
